# 一些流水账和建议

总体来说，计组这门课大部分在于考验细心程度，可以类比为具有很多细节的大模拟程设题。在课下和课上都要细心才可能通过。

## Pre

合理安排进度预习，时间并不紧张。

课上每个工具一个题，（据说）不计分，主要是熟悉工具用。

课上因为忘记怎么仿真试了很久。

## P0-P2

每个工具的单独测试，都不难，课下掌握了基本都能做出来。快的话一个小时左右就能做完。

-------------

从P3开始，都是在课上改课下提交的程序，每题测试课下指令+一条新指令。因此一定要注意课下。加的指令一般是一个计算、一个跳转、一个访存。

## P3

Logisim单周期。

建议课下合理使用Tunnel，布线合理一点，模块化，防止课上手忙脚乱。每条线一定要都接上。

这里讲一下课上遇到的一个小问题，加运算指令的时候出现了TLE，我还以为是课下哪里炸了，看了好久。实际上是新加指令计算的时候太复杂了，我简化了一下运算过程，把四步改成三步就过了。

## P4

Verilog单周期。

本质上就是把Losigim改成Verilog。

要注意清空DM，否则会出现一堆xxxxxxxx。我清空的时候i循环0-1024，但是取i[11:2]清零，所以寄了。课上调这个调了接近1.5h，最后勉强过了两题。

## P5

Verilog流水线。

一定要搞清楚原理、结构再写。可以参考PPT和往届学长的博客。注意阻塞和延迟槽等。

多做测试！多做测试！多做测试！

除去造数据部分外，自动化测试的其他部分可以用python或者c++简单实现。我用python写了评测部分，c++写了模拟CPU部分。对于数据，可以同学间多交流一下，或者找往届学长造的数据。

#### 第一次

第一次挂P献给了P5，看起来挂P5的人并不少， 可能快到50%了。原因十分滑稽，还是DM的问题，P5扩大到了4096，但是我写入的时候写的是A[11:2]，所以寄了（第二天才发现）。最后一题都没过。

值得一提的是，这次的跳转指令里有清空延迟槽的操作，要注意清空的优先级比阻塞低。

#### 第二次

感觉确保课下没有问题的话课上并不难过。70min过了前两题，但是第三题有点奇怪，死活没搞出来。

运算类指令一定要按照他给的操作来模拟，不要自己写等价操作，我自己判断溢出错了好久，按他的写法一遍就过了。

访存是一个根据读出的数据判断写入的寄存器地址的奇怪指令，有两个可能的寄存器地址。但是经过我的实验，暴力暂停到W级再和lw一样转发会TLE，在E和M级判断需要的寄存器是否为两个可能更新的寄存器之一来暂停会run less cycle。感觉是题目有问题。

（第二天重测后发邮件说我过了那题，可还行

## P6

实际上就是在P5的基础上加一些东西。花的时间甚至比P5还要短。注意一些指令行为的规范，比如有些unsigned实际上是假的，需要自行阅读指令集原文。

课上第一题是一个关于乘除模块的简单题，几分钟就写完了，大概是用来强测课下的。后两个题和P5差别不大。课下没问题的话，课上整体比P5还简单。

## P7

P7的课下是比较费工夫的，虽然教程在逐年改进，但仍然避免不了看完仍是一头雾水的情况。可以参考一些学长的博客。这里我把我的理解说一下：

P7需要实现的主要是三个部分：CP0，异常与中断，桥和计时器。这三个部分实际上是互相联系的，不过可以逐个击破。先实现桥和计时器，然后实现CP0，都是只实现功能，不考虑异常和中断。然后再加上异常和中断。

我的CP0是放在M级的，感觉这样比较自然，因为最晚的产生异常的级别是M级，M级操作起来也比较方便。

对于异常，就每一级判断一下是否有产生异常：F判断PC异常（异常视为nop），D判断未知指令，E判断溢出（涉及读写内存的异常代码不同），M判断读写错误。这个信号一直流水即可，如果有多个错误取最早的。然后把信号传入CP0。

对于中断，桥收集了外部中断信号和计时器的中断信号，然后传入CP0。

CP0响应异常和中断后，就把所有级别PC清空成0x4180。（一定要确保异常指令之后的指令全部没有执行！）同理，eret后把所有PC清空成EPC+4。

还有要注意的就是阻塞、乘除模块和中断、eret之间的冲突，需要特殊处理一下。eret判断的位置也有讲究，我觉得同样放在M级比较好。

还有如果响应了外部中断信号，要在下一个周期写一个7f20，这可以用寄存器维护响应信号来实现。



课上一共四个题，功能强测（不含异常和中断，只测指令的正确性），异常强测，中断强测和新加指令。要求是功能强测必做，后面三选二。课下做得好的话直接交完就过了。新加指令是加一种异常情况，也不难，可能对于课下的测试会松一点。